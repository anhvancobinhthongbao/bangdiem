<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Phi·∫øu ƒêi·ªÉm AVCB - T·ª± ƒê·ªông S·∫Øp X·∫øp & Ki·ªÉm So√°t</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap');
        body { font-family: 'Quicksand', sans-serif; background: #f0f4f8; padding: 20px; }
        .no-print { max-width: 850px; margin: 0 auto 20px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 8px solid #1a5276; }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .field { display: flex; flex-direction: column; }
        label { font-weight: 700; font-size: 13px; color: #1a5276; margin-bottom: 4px; }
        input, select { padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
        
        @media print {
            @page { size: A5; margin: 0; }
            body { margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; background: white; }
            .no-print { display: none !important; }
            .report-card { display: flex !important; page-break-after: always; box-shadow: none; page-break-inside: avoid; }
        }

        .report-card { 
            display: none; width: 148mm; height: 210mm; 
            padding: 4mm 10mm 6mm 10mm; 
            margin: 0 auto; 
            background: white; box-sizing: border-box; border: 4px solid #1a5276; 
            flex-direction: column; position: relative;
            overflow: hidden;
        }

        .header { display: flex; align-items: center; border-bottom: 2px solid #1a5276; padding-bottom: 4px; margin-bottom: 8px; }
        .logo { width: 65px; height: 65px; object-fit: contain; margin-right: 12px; }
        .title-box { flex: 1; text-align: center; }
        .title-box h2 { margin: 0; font-size: 18px; color: #1a5276; line-height: 1.2; }
        .title-box h1 { margin: 1px 0; font-size: 14px; color: #d35400; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; font-size: 12.5px; margin-bottom: 6px; }
        .full-row { grid-column: span 2; font-weight: bold; color: #1a5276; margin-top: 0px; }
        
        .score-tbl { width: 100%; border-collapse: collapse; margin-bottom: 6px; }
        .score-tbl th { background: #1a5276; color: white; padding: 4px; font-size: 12px; border: 1px solid #14425e; }
        .score-tbl td { border: 1px solid #d1d8e0; padding: 3px 5px; text-align: center; font-size: 12.5px; }
        
        .remark-box { border: 2px solid #1a5276; border-radius: 10px; padding: 6px 10px; background: #fff; flex-grow: 1; display: flex; flex-direction: column; max-height: 48mm; }
        .remark-title { font-weight: 700; color: #1a5276; margin-bottom: 2px; font-size: 13.5px; border-bottom: 1px solid #eee; }
        .remark-content { font-size: 12.5px; line-height: 1.4; text-align: justify; font-family: 'Times New Roman', serif; flex-grow: 1; }

        .promo-msg { text-align: center; font-style: italic; color: #2980b9; font-size: 12px; margin: 4px 0; font-weight: 700; }
        .reminder-box { text-align: center; background: #fdf2f2; border: 1px solid #feb2b2; padding: 3px; border-radius: 5px; font-size: 11px; color: #c53030; font-weight: bold; margin-bottom: 4px; }
        
        .footer-sig { display: flex; justify-content: space-around; font-weight: 700; font-size: 12.5px; margin-top: 4px; }

        .bottom-area { border-top: 1px dashed #ccc; margin-top: 6px; padding-top: 4px; }
        .qr-area { display: flex; justify-content: center; gap: 20px; margin-bottom: 3px; }
        .qr-item { display: flex; align-items: center; gap: 5px; }
        .qr-box { width: 35px; height: 35px; }
        .qr-txt { font-size: 8px; color: #666; font-style: italic; line-height: 1.1; }
        
        .page-counter { position: absolute; bottom: 8px; right: 10mm; font-size: 9px; color: #aaa; font-weight: bold; }
        .print-tag { text-align: center; font-size: 8px; color: #999; font-weight: bold; }
    </style>
</head>
<body>

<div class="no-print">
    <h3 style="text-align:center; color:#1a5276;">H·ªÜ TH·ªêNG XU·∫§T IN PHI·∫æU ƒêI·ªÇM AVCB</h3>
    <div class="config-grid">
        <div class="field"><label>Ch∆∞∆°ng tr√¨nh:</label><input type="text" id="classType" value="L·ªõp Ph·ªï Th√¥ng"></div>
        <div class="field"><label>Gi√°o vi√™n:</label><input type="text" id="inTea" value="AVCB"></div>
        <div class="field"><label>Ng√†y ƒë√°nh gi√°:</label><input type="date" id="inEval"></div>
        <div class="field"><label>T√™n L·ªõp:</label><input type="text" id="inClassName" placeholder="Flyers K24"></div>
        <div class="field"><label>B·∫Øt ƒë·∫ßu kh√≥a:</label><input type="date" id="inStart"></div>
        <div class="field"><label>K·∫øt th√∫c kh√≥a:</label><input type="date" id="inEnd"></div>
        <div class="field"><label>H·∫°n ƒëƒÉng k√Ω kh√≥a m·ªõi:</label><input type="text" id="inDeadline" placeholder="V√≠ d·ª•: 15/02/2026"></div>
    </div>
    <div style="text-align:center; padding:15px; border:2px dashed #3498db; border-radius:8px;">
        <input type="file" id="excelFile" accept=".xlsx, .xls">
    </div>
    <div id="mapStep" style="display:none; margin-top:15px; background:#fffbe6; padding:15px; border-radius:8px;">
        <div class="config-grid" id="selectors"></div>
        <button onclick="doPrint()" style="background:#27ae60; color:white; width:100%; padding:15px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin-top:10px;">üöÄ XU·∫§T IN PHI·∫æU ƒêI·ªÇM </button>
    </div>
</div>

<div id="printArea"></div>

<script>
    document.getElementById('inEval').valueAsDate = new Date();
    let excelData = [];
    const mappingFields = [
        {id: 'colName', label: 'T√™n H·ªçc Sinh', keys: ['t√™n', 'student']},
        {id: 'colRW', label: 'ƒê·ªçc - Vi·∫øt', keys: ['ƒë·ªçc', 'writing']},
        {id: 'colL', label: 'Nghe', keys: ['nghe', 'listening']},
        {id: 'colS', label: 'N√≥i', keys: ['n√≥i', 'speaking']},
        {id: 'colP', label: 'Chuy√™n c·∫ßn', keys: ['tham gia']},
        {id: 'colTotal', label: 'T·ªïng ƒëi·ªÉm', keys: ['t·ªïng', 'total']},
        {id: 'colClass', label: 'X·∫øp lo·∫°i', keys: ['lo·∫°i', 'classification']},
        {id: 'colRem', label: 'Nh·∫≠n x√©t', keys: ['nh·∫≠n x√©t', 'remarks']}
    ];

    document.getElementById('excelFile').addEventListener('change', (e) => {
        let reader = new FileReader();
        reader.onload = (f) => {
            let wb = XLSX.read(f.target.result, {type: 'binary'});
            excelData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval: ""});
            if(excelData.length > 0) {
                let headers = Object.keys(excelData[0]);
                let html = "";
                mappingFields.forEach(field => {
                    html += `<div class="field"><label>${field.label}:</label><select id="${field.id}">`;
                    headers.forEach(h => {
                        let sel = field.keys.some(k => h.toLowerCase().includes(k)) ? "selected" : "";
                        html += `<option value="${h}" ${sel}>${h}</option>`;
                    });
                    html += `</select></div>`;
                });
                document.getElementById('selectors').innerHTML = html;
                document.getElementById('mapStep').style.display = 'block';
            }
        };
        reader.readAsBinaryString(e.target.files[0]);
    });

    function fmtDate(d) { return d ? new Date(d).toLocaleDateString('vi-VN') : "__/__/____"; }

    function getQuote(cls, rank) {
        if (rank === 1) return "ü•á H·∫°ng 1! Ch√∫c m·ª´ng em nh·∫≠n qu√† ƒê·∫∂C BI·ªÜT t·ª´ Trung t√¢m!";
        if (rank === 2) return "ü•à H·∫°ng 2! Ch√∫c m·ª´ng em nh·∫≠n qu√† H·∫§P D·∫™N t·ª´ Trung t√¢m!";
        if (rank === 3) return "ü•â H·∫°ng 3! Ch√∫c m·ª´ng em nh·∫≠n qu√† KHUY·∫æN KH√çCH t·ª´ Trung t√¢m!";
        return "üåü C·ªë g·∫Øng l√™n! Trung T√¢m tin r·∫±ng em s·∫Ω b·ª©t ph√° h∆°n ·ªü kh√≥a h·ªçc sau!";
    }

    function doPrint() {
        const area = document.getElementById('printArea');
        area.innerHTML = "";
        const m = {};
        mappingFields.forEach(f => m[f.id] = document.getElementById(f.id).value);
        const deadline = document.getElementById('inDeadline').value || "____";

        // 1. T√≠nh to√°n ƒëi·ªÉm ƒë·ªÉ x·∫øp h·∫°ng
        let scores = excelData
            .map(r => parseFloat(r[m.colTotal]) || 0)
            .filter((v, i, a) => a.indexOf(v) === i)
            .sort((a, b) => b - a);

        // 2. S·∫Øp x·∫øp l·∫°i danh s√°ch h·ªçc sinh theo h·∫°ng tƒÉng d·∫ßn (H·∫°ng 1 ƒë·ª©ng ƒë·∫ßu)
        let sortedData = excelData
            .filter(r => r[m.colName])
            .sort((a, b) => {
                let scoreA = parseFloat(a[m.colTotal]) || 0;
                let scoreB = parseFloat(b[m.colTotal]) || 0;
                return scoreB - scoreA; // Cao ƒëi·ªÉm x·∫øp tr∆∞·ªõc
            });

        const totalPages = sortedData.length;

        sortedData.forEach((r, i) => {
            let currentScore = parseFloat(r[m.colTotal]) || 0;
            let autoRank = scores.indexOf(currentScore) + 1;

            const card = document.createElement('div');
            card.className = 'report-card';
            card.innerHTML = `
                <div class="header">
                    <img src="LOGO AVCB FINAL_logoAVCB final-white background.png" class="logo">
                    <div class="title-box">
                        <h2>ANH VƒÇN C√î B√åNH</h2>
                        <h1>ENGLISH REPORT CARD (PHI·∫æU IN K·∫æT QU·∫¢ H·ªåC T·∫¨P)</h1>
                        <small>(${document.getElementById('classType').value})</small>
                    </div>
                </div>
                <div class="info-grid">
                    <div><b>H·ªçc sinh:</b> ${r[m.colName]}</div>
                    <div><b>L·ªõp:</b> ${document.getElementById('inClassName').value}</div>
                    <div><b>Gi√°o vi√™n:</b> ${document.getElementById('inTea').value}</div>
                    <div><b>Ng√†y ƒë√°nh gi√°:</b> ${fmtDate(document.getElementById('inEval').value)}</div>
                    <div class="full-row">Kh√≥a h·ªçc: ${fmtDate(document.getElementById('inStart').value)} - ${fmtDate(document.getElementById('inEnd').value)}</div>
                </div>
                <table class="score-tbl">
                    <tr><th width="70%">N·ªòI DUNG</th><th>K·∫æT QU·∫¢</th></tr>
                    <tr><td style="text-align:left">Reading - Writing</td><td><b>${r[m.colRW]}</b></td></tr>
                    <tr><td style="text-align:left">Listening</td><td><b>${r[m.colL]}</b></td></tr>
                    <tr><td style="text-align:left">Speaking</td><td><b>${r[m.colS]}</b></td></tr>
                    <tr><td style="text-align:left">Participation</td><td><b>${r[m.colP]}</b></td></tr>
                    <tr style="background:#fff9db"><td><b>Overall Score</b></td><td><b>${r[m.colTotal]}</b></td></tr>
                    <tr><td><b>Rank (H·∫°ng)</b></td><td><b style="color:#d35400;">${autoRank}</b></td></tr>
                    <tr><td><b>Classification</b></td><td><b>${r[m.colClass]}</b></td></tr>
                </table>
                <div class="remark-box">
                    <span class="remark-title">8. Nh·∫≠n x√©t c·ªßa gi√°o vi√™n:</span>
                    <div class="remark-content">${r[m.colRem] || "Con ho√†n th√†nh t·ªët kh√≥a h·ªçc."}</div>
                </div>
                <div class="promo-msg">"${getQuote(r[m.colClass], autoRank)}"</div>
                <div class="reminder-box">‚ö†Ô∏è Kh√≥a ti·∫øp theo s·∫Ω khai gi·∫£ng v√†o ng√†y ${deadline} .</div>
                <div class="footer-sig"><div></div><div></div></div>
                <div class="bottom-area">
                    <div class="qr-area">
                        <div class="qr-item"><div id="qra${i}" class="qr-box"></div><div class="qr-txt"><b>iOS App</b><br>Qu√©t t·∫£i App AVCB</div></div>
                        <div class="qr-item"><div id="qrg${i}" class="qr-box"></div><div class="qr-txt"><b>Android App</b><br>Qu√©t t·∫£i App AVCB</div></div>
                    </div>
                    <div class="print-tag">Ng√†y in: ${new Date().toLocaleDateString('vi-VN')}</div>
                </div>
                <div class="page-counter">Trang ${i + 1}/${totalPages}</div>`;
            area.appendChild(card);
            new QRCode(document.getElementById(`qra${i}`), {text: "https://apps.apple.com/vn/app/avcb/id1672556634", width: 35, height: 35});
            new QRCode(document.getElementById(`qrg${i}`), {text: "https://play.google.com/store/apps/details?id=dotb.cloud.avcb", width: 35, height: 35});
        });
        setTimeout(() => window.print(), 800);
    }
</script>
</body>
</html>